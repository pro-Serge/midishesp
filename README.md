# MiDishESP
Управление посудомоечной машиной Midea с помощью ESP8266/ESP32 плат и ESPHome

Имеется: посудомоечная машина (ПММ) Midea MID60S300. Основана на плате управления WQP12-7601.D.1-1 V1.1 (также эта плата может маркироваться как LYP03877A0(X))

![WQP12-7601.jpg](images/WQP12-7601.jpg)

Машинка не имеет модуля Wi-Fi, но имеет разведенный на плате управления UART (разъем CN1).

![CN1](images/cn1.JPG)

Задача: интегрировать ПММ в систему "умный дом" на базе Home Assistant и ESPHome для управления и мониторинга работы.

Параметры порта на плате такие: 9600, 8-N-1.

В режиме ожидания (да и во время выполнения программы) ПММ передает в UART такой пакет (числа в шестнадцатеричном формате):
55 0D 89 02 00 00 00 00 00 00 00 00 00 00 00 8B
Где: 
1. 55h - признак начала пакета (01010101 в бинарном виде)
2. 0Dh - длина пакета (13 байт)
3. 89h - код оборудования/команда???
4. 02h - статус/команда

...

16. 8Bh - CRC

Плата реагирует на отправку пакетов с любым значением байтов 3 и 4.

Формат пакета для отправки
1. 55h - признак начала пакета (01010101 в бинарном виде)
2. 0Dh - длина пакета (13 байт)
3. любое значение <s>89h - код оборудования???</s>
4. любое значение <s>команда - (01h - запись параметра)</s>
5. первый байт параметра
6. второй байт параметра
7. третий байт параметра
8. четвертый байт параметра

...

15. одиннадцатый байт параметра

16. CRC.

Принятый пакет имеет вид:

1. 55h - признак начала пакета (01010101 в бинарном виде)
2. 0Dh - длина пакета (13 байт)
3. 89h - код оборудования???
4. 02h - статус???
5. первый байт параметра из переданного пакета
6. второй байт
7. третий байт
8. четвертый

...

15. одиннадцатый байт
16. CRC

Попробуем понять, как считается CRC

Примеры пакетов, полученных от ПММ:

>55 0d 89 02 <b>00</b> 00 00 00 00 00 00 00 00 00 00 8b<br>
>55 0d 89 02 <b>01</b> 00 00 00 00 00 00 00 00 00 00 8c<br>
>55 0d 89 02 <b>02</b> 00 00 00 00 00 00 00 00 00 00 8d<br>
>55 0d 89 02 <b>04</b> 00 00 00 00 00 00 00 00 00 00 8f<br>
>55 0d 89 02 <b>05</b> 00 00 00 00 00 00 00 00 00 00 90<br>

>55 0d 89 02 <b>01 01</b> 00 00 00 00 00 00 00 00 00 8d<br>
>55 0d 89 02 <b>01 02</b> 00 00 00 00 00 00 00 00 00 8e<br>
>55 0d 89 02 <b>01 03</b> 00 00 00 00 00 00 00 00 00 8f<br>
>55 0d 89 02 <b>01 04</b> 00 00 00 00 00 00 00 00 00 90<br>

>55 0d 89 02 <b>05 01</b> 00 00 00 00 00 00 00 00 00 91<br>
>55 0d 89 02 <b>05 02</b> 00 00 00 00 00 00 00 00 00 92<br>
>55 0d 89 02 <b>05 03</b> 00 00 00 00 00 00 00 00 00 93<br>
>55 0d 89 02 <b>05 04</b> 00 00 00 00 00 00 00 00 00 94<br>

Попытаемся проанализировать. Очень похоже на последний байт суммы всех байтов с третьего по последний.
Попробуем посчитать вручную для вот такого пакета:

>55 0d 89 02 1a 0a 5f fa 00 00 00 00 00 00 -> 08

Проверяем ответ от машинки... Да, все правильно. Так и есть. Теперь мы можем посчитать правильный CRC для отправляемых пакетов!
Попробуем отправить пакет с "правильным" CRC. Например вот такой:
>55 0d 02 01 01 00 00 00 00 00 00 00 00 00 00 04<br>

и... получаем такой ответ (первый пакет однократно, второй повторяется):
>55 0d 29 02 01 00 00 00 00 00 00 00 00 00 00 2c<br>
>55 0d a9 02 01 00 00 00 00 00 00 00 00 00 00 ac<br>

Ответ на этот же запрос после сброса питания вот такой:
>55 0d 09 02 01 00 00 00 00 00 00 00 00 00 00 0c<br>
>55 0d 89 02 01 00 00 00 00 00 00 00 00 00 00 8c<br>


Отправляем:
>55 0d 01 01 01 00 00 00 00 00 00 00 00 00 00 03<br>

Получаем (первый пакет однократно, второй повторяется):
>55 0d 19 02 01 00 00 00 00 00 00 00 00 00 00 1c<br>
>55 0d 99 02 01 00 00 00 00 00 00 00 00 00 00 9c<br>

Третий байт:

Если установлен хотя бы один из младших двух битов, в ответ получаем два пакета:

Отправляем 0, получаем 09,89

Отправляем 1, получаем 19,99

Отправляем 2, получаем 29,A9

Отправляем 3, получаем 49,C9

Если установлен хотя бы один из старших четырех битов, получаем один пакет с таким же значением третьего байта, как и в запросе: отправляем 10h, получаем 10h, отправляем 20h, получаем 20h и т.д.

Четвертый байт:

Может принимать значения 00, 01 или 02

Третий и четвертый байты это битовая маска.

# Список известных ПММ, основанных на плате WQP12-7601.D.1-1
1. Midea MID60S300
2. Hansa ZIM608EH
3. Electrolux ESF2400OK
4. LERAN BDW 45-104
5. Hyundai HBD440
6. GRAUDE VG60.0
7. Candy CDI 2L10473
8. Gorenje GV 53311
9. Hansa ZWM 416 WH
10. Gorenje MGV5510
11. Weissgauff BDW4138D
12. Samsung DW60M6050BB
13. Samsung DW50R4050W/FS/BB
14. Hansa ZIM447ELH
15. Hansa ZIM626H
16. Hansa ZIM476H
17. Gorenje GV55110
18. Krona KAMAYA 45
19. DEXP M10C6PB
20. Kenwood KDW60X15
21. Kenwood KDW60X20
22. Candy CDCP8
